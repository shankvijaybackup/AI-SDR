generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// ==================== MULTI-TENANCY ====================

model Company {
  id                  String   @id @default(uuid())
  name                String
  slug                String   @unique  // URL-friendly identifier
  plan                String   @default("trial")  // trial, starter, pro, enterprise
  twilioSubAccountSid String?  // Optional Twilio sub-account for isolation
  billingEmail        String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  users               User[]
  leads               Lead[]
  calls               Call[]
  scripts             Script[]
  phoneNumbers        RegionalPhoneNumber[]
  campaigns           BulkCallCampaign[]
  knowledgeSources    KnowledgeSource[]
  invites             CompanyInvite[]
  settings            CompanySettings?

  @@index([slug])
}

model CompanySettings {
  id                 String   @id @default(uuid())
  companyId          String   @unique
  
  // API Keys (stored encrypted in production)
  twilioAccountSid   String?
  twilioAuthToken    String?
  openaiApiKey       String?
  googleAiApiKey     String?
  elevenLabsApiKey   String?
  deepgramApiKey     String?
  
  // Feature Flags
  aiCallingEnabled   Boolean  @default(true)
  knowledgeBaseEnabled Boolean @default(true)
  
  // Billing
  trialEndsAt        DateTime?
  stripeCustomerId   String?
  stripePriceId      String?
  subscriptionStatus String?  @default("trialing") // trialing, active, past_due, canceled
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  company            Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model CompanyInvite {
  id        String   @id @default(uuid())
  companyId String
  email     String
  role      String   @default("member")  // admin, member
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, email])
  @@index([token])
}

// ==================== USERS ====================

model User {
  id                    String            @id @default(uuid())
  companyId             String?           // Optional for migration, required after
  email                 String            @unique
  password              String
  firstName             String
  lastName              String
  companyName           String?           // Deprecated: use company.name
  role                  String            @default("member")  // admin, member
  linkedinSessionCookie String?
  
  // Activation & Verification
  isActive              Boolean   @default(false)
  isEmailVerified       Boolean   @default(false)
  emailVerificationToken String?  @unique
  emailVerificationExpiry DateTime?
  magicLinkToken        String?   
  resetToken            String?   @unique
  resetTokenExpiry      DateTime?
  magicLinkExpiry       DateTime?
  lastLoginAt           DateTime?

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  // Relations
  company               Company?          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  calls                 Call[]
  knowledgeSources      KnowledgeSource[]
  leads                 Lead[]
  scripts               Script[]
  bulkCallCampaigns     BulkCallCampaign[]
  regionalPhoneNumbers  RegionalPhoneNumber[]

  @@index([companyId])
  @@index([isActive])
  @@index([isEmailVerified])
}

// ==================== PHONE NUMBERS ====================

model RegionalPhoneNumber {
  id          String   @id @default(uuid())
  companyId   String?  // Company-level phone numbers
  userId      String?  // Keep for backward compatibility
  region      String   // e.g., "ANZ", "US", "UK", "India", "EU"
  phoneNumber String   // e.g., "+61341574513"
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  company     Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([companyId, region])
  @@index([companyId])
  @@index([userId])
}

// ==================== LEADS ====================

model Lead {
  id               String    @id @default(uuid())
  companyId        String?   // Company-scoped
  userId           String    // Creator/owner
  firstName        String
  lastName         String
  email            String?
  phone            String
  company          String?
  jobTitle         String?
  linkedinUrl      String?
  notes            String?
  linkedinEnriched Boolean   @default(false)
  linkedinData     Json?
  status           String    @default("pending")
  interestLevel    String?
  region           String?   // India, UK, Australia, US
  nextFollowUp     DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  calls            Call[]
  companyRelation  Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([companyId, interestLevel])
  @@index([userId, status])
  @@index([userId, interestLevel])
}

// ==================== SCRIPTS ====================

model Script {
  id        String   @id @default(uuid())
  companyId String?   // Company-scoped
  userId    String?
  name      String
  content   String
  isDefault Boolean  @default(false)
  isShared  Boolean  @default(false)
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  calls              Call[]
  company            Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user               User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bulkCallCampaigns  BulkCallCampaign[]

  @@index([companyId])
  @@index([userId])
  @@index([isShared])
}

// ==================== CALLS ====================

model Call {
  id               String    @id @default(uuid())
  companyId        String?   // Company-scoped
  userId           String
  leadId           String
  scriptId         String?
  campaignId       String?   // Link to bulk call campaign
  twilioCallSid    String?   @unique
  voicePersona     String    @default("female")
  transcript       Json
  duration         Int?
  status           String    @default("initiated")
  disconnectReason String?   // Human-readable: "No answer after 5 rings", etc.
  aiSummary        String?
  interestLevel    String?
  outcome          String?
  conversionStage  String?
  sentimentScore   Float?
  engagementScore  Float?
  callQualityScore Float?
  objections       String[]
  emailCaptured    String?
  nextSteps        String?
  scheduledDemo    DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  company          Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lead             Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  script           Script?   @relation(fields: [scriptId], references: [id])
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign         BulkCallCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([userId, leadId])
  @@index([twilioCallSid])
  @@index([campaignId])
}

// ==================== CAMPAIGNS ====================

model BulkCallCampaign {
  id                String    @id @default(uuid())
  companyId         String?   // Company-scoped
  userId            String
  name              String
  scriptId          String
  status            String    @default("pending") // pending, running, paused, completed, cancelled
  totalLeads        Int       @default(0)
  completedCalls    Int       @default(0)
  successfulCalls   Int       @default(0)
  failedCalls       Int       @default(0)
  currentLeadIndex  Int       @default(0)  // Index of current lead being called
  leadIds           String[]  // Array of lead IDs to call
  delayBetweenCalls Int       @default(5)  // seconds between calls
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  completedAt       DateTime?
  
  company           Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  script            Script    @relation(fields: [scriptId], references: [id])
  calls             Call[]

  @@index([companyId, status])
  @@index([userId, status])
}

// ==================== KNOWLEDGE ====================

model KnowledgeSource {
  id              String   @id @default(uuid())
  companyId       String?  // Company-scoped
  userId          String?
  title           String
  description     String?
  type            String
  fileUrl         String?
  fileName        String?
  fileSize        Int?
  mimeType        String?
  videoUrl        String?
  videoDuration   Int?
  videoTranscript String?
  content         String
  summary         String?
  embeddings      Json?
  chunks          Json?
  tags            String[]
  category        String?
  isActive        Boolean  @default(true)
  isShared        Boolean  @default(false)
  createdBy       String?
  status          String   @default("pending")
  processingError String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  company         Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId, isActive])
  @@index([userId, isActive])
  @@index([isShared])
  @@index([category])
  @@index([status])
}
