generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String            @id @default(uuid())
  email                 String            @unique
  password              String
  firstName             String
  lastName              String
  company               String?
  role                  String            @default("SDR")
  linkedinSessionCookie String?
  
  // Activation & Verification
  isActive              Boolean   @default(false)
  isEmailVerified       Boolean   @default(false)
  emailVerificationToken String?  @unique
  emailVerificationExpiry DateTime?
  magicLinkToken        String?   @unique
  magicLinkExpiry       DateTime?
  lastLoginAt           DateTime?

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  calls                 Call[]
  knowledgeSources      KnowledgeSource[]
  leads                 Lead[]
  scripts               Script[]

  @@index([isActive])
  @@index([isEmailVerified])
}

model Lead {
  id               String    @id @default(uuid())
  userId           String
  firstName        String
  lastName         String
  email            String?
  phone            String
  company          String?
  jobTitle         String?
  linkedinUrl      String?
  notes            String?
  linkedinEnriched Boolean   @default(false)
  linkedinData     Json?
  status           String    @default("pending")
  interestLevel    String?
  nextFollowUp     DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  calls            Call[]
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, interestLevel])
}

model Script {
  id        String   @id @default(uuid())
  userId    String?
  name      String
  content   String
  isDefault Boolean  @default(false)
  isShared  Boolean  @default(false)
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  calls     Call[]
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isShared])
}

model Call {
  id            String    @id @default(uuid())
  userId        String
  leadId        String
  scriptId      String?
  twilioCallSid String?   @unique
  voicePersona  String    @default("female")
  transcript    Json
  duration      Int?
  status        String    @default("initiated")
  aiSummary     String?
  interestLevel String?
  objections    String[]
  emailCaptured String?
  nextSteps     String?
  scheduledDemo DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lead          Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  script        Script?   @relation(fields: [scriptId], references: [id])
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, leadId])
  @@index([twilioCallSid])
}

model KnowledgeSource {
  id              String   @id @default(uuid())
  userId          String?
  title           String
  description     String?
  type            String
  fileUrl         String?
  fileName        String?
  fileSize        Int?
  mimeType        String?
  videoUrl        String?
  videoDuration   Int?
  videoTranscript String?
  content         String
  summary         String?
  embeddings      Json?
  chunks          Json?
  tags            String[]
  category        String?
  isActive        Boolean  @default(true)
  isShared        Boolean  @default(false)
  createdBy       String?
  status          String   @default("pending")
  processingError String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([isShared])
  @@index([category])
  @@index([status])
}
